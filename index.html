<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Loly Radio Player - Fancy Edition</title>
  <style>
    /* Fix box-sizing for all elements */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px 20px; /* reduced vertical padding */
      user-select: none;
      background: transparent;
      overflow: hidden; /* prevent vertical scroll */
    }
    #player-container {
      background: rgba(0, 0, 0, 0.65);
      border-radius: 20px;
      padding: 30px;
      width: 320px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      text-align: center;
      position: relative;
      max-height: 100vh;
      overflow: hidden;
    }
    #artwork {
      width: 250px;
      height: 250px;
      border-radius: 20px;
      object-fit: cover;
      margin-bottom: 20px;
      border: 4px solid #5a4a8a;
      box-shadow: 0 0 30px #8e8aff;
      transition: transform 0.5s ease;
    }
    #title {
      font-weight: 600;
      font-size: 20px;
      margin-bottom: 10px;
      min-height: 28px;
    }
    #audio-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 15px;
    }
    button#play-pause {
      background: #6decb9;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 15px #4bcaa7;
      transition: background 0.3s ease;
    }
    button#play-pause:hover {
      background: #3cc998;
      box-shadow: 0 6px 20px #31a07f;
    }
    button#play-pause svg {
      width: 24px;
      height: 24px;
      fill: #121212;
    }
    #progress-bar {
      flex-grow: 1;
      height: 8px;
      background: #444;
      border-radius: 5px;
      cursor: pointer;
      overflow: hidden;
      position: relative;
    }
    #progress {
      height: 100%;
      background: #6decb9;
      width: 0%;
      transition: width 0.3s ease;
    }
    #volume-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    input[type="range"] {
      -webkit-appearance: none;
      width: 120px;
      background: transparent;
      cursor: pointer;
    }
    input[type="range"]:focus {
      outline: none;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      height: 8px;
      background: #6decb9;
      border-radius: 4px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #3cc998;
      border-radius: 50%;
      cursor: pointer;
      margin-top: -6px;
      transition: background 0.3s ease;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      background: #1f7d6b;
    }
    input[type="range"]:focus::-webkit-slider-thumb {
      box-shadow: 0 0 10px #1f7d6b;
    }
    #loading-text {
      margin-top: 15px;
      font-size: 14px;
      color: #bbb;
      min-height: 20px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="player-container">
    <img id="artwork" src="https://dummyimage.com/300x300/555/ccc&text=Radio+Live" alt="Album Art" />
    <div id="title">Loading current song...</div>
    <div id="audio-controls">
      <button id="play-pause" aria-label="Play/Pause">
        <svg viewBox="0 0 24 24" id="play-icon"><path d="M8 5v14l11-7z"/></svg>
        <svg viewBox="0 0 24 24" id="pause-icon" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
      </button>
      <div id="progress-bar" title="Track progress">
        <div id="progress"></div>
      </div>
    </div>
    <div id="volume-control" title="Volume control">
      <label for="volume" style="color:#6decb9;">🔊</label>
      <input type="range" id="volume" min="0" max="1" step="0.01" value="1">
    </div>
    <div id="loading-text"></div>
  </div>

  <audio id="audio" preload="auto" crossorigin="anonymous">
    <source src="https://waveradio.mooo.com/stream" type="audio/mpeg" />
    Your browser does not support the audio element.
  </audio>

  <script>
    const LASTFM_API_KEY = "83b6fcb8f3c604294727740c15060940";
    const audio = document.getElementById('audio');
    const playPauseBtn = document.getElementById('play-pause');
    const playIcon = document.getElementById('play-icon');
    const pauseIcon = document.getElementById('pause-icon');
    const progressBar = document.getElementById('progress-bar');
    const progress = document.getElementById('progress');
    const volumeControl = document.getElementById('volume');
    const artwork = document.getElementById('artwork');
    const title = document.getElementById('title');
    const loadingText = document.getElementById('loading-text');

    playPauseBtn.addEventListener('click', () => {
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
    });

    audio.addEventListener('play', () => {
      playIcon.style.display = 'none';
      pauseIcon.style.display = 'block';
      loadingText.textContent = "";
    });

    audio.addEventListener('pause', () => {
      playIcon.style.display = 'block';
      pauseIcon.style.display = 'none';
      loadingText.textContent = "Paused";
    });

    audio.addEventListener('timeupdate', () => {
      if (audio.duration) {
        const percent = (audio.currentTime / audio.duration) * 100;
        progress.style.width = percent + '%';
      }
    });

    progressBar.addEventListener('click', (e) => {
      const rect = progressBar.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const width = rect.width;
      if (audio.duration) {
        audio.currentTime = (clickX / width) * audio.duration;
      }
    });

    volumeControl.addEventListener('input', (e) => {
      audio.volume = e.target.value;
    });

    async function fetchMetadata() {
      try {
        const res = await fetch("https://waveradio.work.gd/status-json.xsl");
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();

        let source = Array.isArray(data.icestats.source)
          ? data.icestats.source.find(s => s.listenurl.includes("stream"))
          : data.icestats.source;

        if (!source || !source.title) throw new Error("Stream metadata not found");

        let rawTitle = source.title || "";
        const cleanedTitle = rawTitle
          .replace(/[“”]/g, '"')
          .replace(/[‘’]/g, "'")
          .replace(/[^\x00-\x7F]/g, "")
          .trim();

        let artist = "", track = "";

        if (cleanedTitle.includes(" - ")) {
          [artist, track] = cleanedTitle.split(" - ").map(x => x.trim());
        } else if (cleanedTitle.includes(" ― ")) {
          [track, artist] = cleanedTitle.split(" ― ").map(x => x.trim());
        } else if (cleanedTitle.includes(" – ")) {
          [track, artist] = cleanedTitle.split(" – ").map(x => x.trim());
        } else {
          track = cleanedTitle;
        }

        const displayTitle = artist && track ? `${artist} - ${track}` : track;
        title.textContent = displayTitle || "No Title";

        const searchQuery = encodeURIComponent(`${artist} ${track}`.trim());

        const itunesRes = await fetch(`https://itunes.apple.com/search?term=${searchQuery}&media=music&limit=1`);
        const itunesData = await itunesRes.json();

        if (itunesData.results.length > 0) {
          const artworkUrl = itunesData.results[0].artworkUrl100.replace('100x100bb', '300x300bb');
          artwork.src = artworkUrl;
        } else {
          if (artist && track) {
            const lastfmRes = await fetch(`https://ws.audioscrobbler.com/2.0/?method=track.getInfo&api_key=${LASTFM_API_KEY}&artist=${encodeURIComponent(artist)}&track=${encodeURIComponent(track)}&format=json`);
            const lastfmData = await lastfmRes.json();
            const images = lastfmData?.track?.album?.image || [];
            const image = images.length ? images[images.length - 1]['#text'] : null;

            if (image) {
              artwork.src = image;
            } else {
              artwork.src = "https://dummyimage.com/300x300/555/ccc&text=Radio+Live";
            }
          } else {
            artwork.src = "https://dummyimage.com/300x300/555/ccc&text=Radio+Live";
          }
        }
      } catch (error) {
        console.error("Metadata error:", error);
        title.textContent = "Unable to load song info";
        artwork.src = "https://dummyimage.com/300x300/555/ccc&text=Radio+Live";
      }
    }

    fetchMetadata();
    setInterval(fetchMetadata, 15000);
  </script>
</body>
</html>
